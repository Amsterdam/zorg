swagger: '2.0'

info:
  version: "1.0.0"
  title: Datapunt Amsterdam Zorg
  description: |
    ## Guid

    De `guid` is de unieke sleutel van elke entiteit in de applicatie.

    Bij het aanmaken van organisaties, voegt de applicatie zelf een `guid` toe
    op basis van de gebruiker.

    Bij het aanmaken van locaties en activiteiten voegt de applicatie zelf een `guid` toe
    op basis van de gebruiker aangevuld met het `id` in de aanroep.

    Indien een `guid` wordt meegestuurd bij een van bovenstaande acties wordt deze door het systeem genegeerd.

    Bij `lees`, `update` en `verwijder` opdrachten moet de `guid` wel meegestuurd worden.

    Het gebruik van een guid maakt het mogelijk om meerdere partijen hun eigen id reeks te laten gebruiken
    zonder dat dit leidt tot conflicten in het zorg-portaal.

    Op termijn is het de bedoeling om ook gebruik te maken van het eigen id voor lees, update en verwijder
    opdrachten. Dit ligt voorlopig nog buiten de scope van het project.

    ## Authenticatie

    Voor het ophalen van data via een `http GET request` is geen authenticatie nodig.
    Het toevoegen en wijzigen van data vereist echter een API token.

    [Meer informatie over API tokens](https://scotch.io/tutorials/the-ins-and-outs-of-token-based-authentication)

    -en-

    [Hoe deze te implementeren](http://www.django-rest-framework.org/api-guide/authentication/#tokenauthentication).

schemes:
  - https

consumes:
  - application/json

produces:
  - application/json

################################################################################
#                                     Paths                                    #
################################################################################

paths:
  /zorg/status/health:
    get:
      tags: [ status ]
      # operationId: health.views.health
      summary: Ok, als de server draait
      responses:
        200:
          description: status health check
          schema:
            type: string
        500:
          description: server error
          schema:
            $ref: '#/definitions/error_response'

  /zorg/status/data:
    get:
      tags: [ status ]
      summary: Ok, als data bereikbaar is.
      # operationId: health.views.data
      responses:
        200:
          description: status data health check
          schema:
            type: string
        500:
          description: server error
          schema:
            $ref: '#/definitions/error_response'

  /zorg/batch_update:
    post:
      tags: [ batch ]
      description: |
        ### Batch update

        #### In ontwikkeling

        batch_update accepteert een payload met zgn. `operaties`. Deze operaties worden uitgevoerd op onze datacollectie.

        Een operatie bestaat altijd uit een key `operatie` met als de mogelijk waarden:
          - `insert`,
          - `patch` of
          - `delete`.

        een key `locatie` en een key `activiteit`.

        ### bijvoorbeeld:
        ```javascript
          [
            {"operatie":"insert",
             "locatie": <locatie-rec>,
             "activiteit": <activiteit-rec>},
            {"operatie":"patch",
             "locatie": <locatie-changes>,
             "activiteit": <activiteit-changes>},
            {"operatie":"delete":
             "locatie": <locatie-guid>,
             "activiteit": <activiteit-guid>}
          ]
        ```

      summary: Aanleveren van wijzigingen in een batch
      responses:
        202:
          description: accepted the request and queued the payload for processing
          schema:
            $ref: '#/definitions/batch_job'
        500:
          description: server error
      parameters:
      -
        name: payload
        in: body
        description: The payload for this request
        schema:
          type: array
          items:
            $ref: '#/definitions/batch_record'

  /zorg/batch_job/{jobid}:
    get:
      tags: [  batch ]
      summary: opvragen van informatie over batch jobs
      description: |
        #### In ontwikkeling

      parameters:
      -
        name: jobid
        in: path
        description: De jobid van de verwerking die gezocht wordt
        type: string
        required: true
      responses:
        200:
          description: batch
          schema:
            $ref: '#/definitions/batch_job'
        500:
          description: server error

  /zorg/tags/{categorie}:
    get:
      tags: [ tags ]
      summary: opvragen van tags cq. labels per categorie
      parameters:
      -
        name: categorie
        in: path
        description: de tag categorie die geselecteerd moet worden
        type: string
        enum:
          - BETAALD
          - DAG
          - TIJD
        required: true
      responses:
        200:
          description: alle tags voor gevraagde categoroe
          schema:
            $ref: '#/definitions/tagdefinitie'
        500:
          description: server error

  /zorg/zoek/:
    get:
      tags: [ zoekingangen ]
      summary: |
        Zoek over alle data in het systeem. Als `lat` en `lon` gegeven zijn dan
        worden de resultaten primair gesorteerd op afstand.
      # operationId: api.ZoekApiView.as_view
      parameters:
      - $ref: '#/parameters/query'
      - $ref: '#/parameters/tag'
      - $ref: '#/parameters/latitude'
      - $ref: '#/parameters/longitude'
      responses:
        200:
          $ref: '#/responses/200-zoek'
        500:
          $ref: '#/responses/500'

  /zorg/zoek/{subtype}:
    get:
      tags: [ zoekingangen ]
      summary: |
        Zoek over de `subtype` data in het systeem. Als `lat` en `lon` gegeven
        zijn dan worden de resultaten primair gesorteerd op afstand.
      # operationId: api.ZoekApiView.as_view
      parameters:
      - $ref: '#/parameters/query'
      - $ref: '#/parameters/tag'
      - $ref: '#/parameters/latitude'
      - $ref: '#/parameters/longitude'
      -
        name: subtype
        in: path
        description: '`organisatie`, `locatie` of `activiteit`'
        type: string
        required: true
        enum:
          - organisatie
          - locatie
          - activiteit
      responses:
        200:
          $ref: '#/responses/200-zoek'
        500:
          $ref: '#/responses/500'


  /zorg/organisatie/{guid}:
    get:
      tags: [ organisaties ]
      summary: Toon de organisatie met deze guid
      produces:
        - application/json
      parameters:
      -
        name: guid
        in: path
        description: Paginering, toont de gevraagde pagina.
        type: string
        required: true
      responses:
        200:
          description: retourneert een `organisatie` data record
          schema:
            $ref: '#/definitions/organisatie'
        500:
          $ref: '#/responses/500'
    put:
      tags: [ organisaties ]
      summary: Wijzig de gegevens van de organisatie met deze guid
      produces:
        - application/json
      consumes:
        - application/json
      parameters:
      - name: guid
        in: path
        description: De guid van het organisatie object dat gewijzigd moet worden
        type: string
        required: true
      - in: body
        name: body
        description: wijzig `organisatie` object
        required: false
        schema:
          $ref: '#/definitions/organisatie'
      responses:
        "405":
          description: Validation error
        "404":
          description: Activiteit not found
        "400":
          description: Bad request, invalid URL
        "200":
          description: Update successful
    delete:
      tags: [ organisaties ]
      summary: Verwijder de organisatie met deze guid
      parameters:
      - name: guid
        in: path
        description: Het guid van de organisatie die verwijderd gaat worden
        type: string
        required: true
      responses:
        "200":
          description: Delete successful

  /zorg/organisatie:
    get:
      tags: [ organisaties ]
      summary: Toon de lijst met organisaties
      # operationId: api.datasets.normailzed.views.OrganisatieViewSet
      produces:
        - application/json
      parameters:
      -
        name: page
        in: query
        description: Paginering, toont de gevraagde pagina.
        type: number
        format: int64
        required: false
      responses:
        200:
          description: Retourneert een lijst met organisaties
          schema:
            type: object
            properties:
              _links:
                $ref: '#/definitions/_links'
              results:
                type: array
                items:
                  $ref: '#/definitions/results'
        500:
          description: server error
          schema:
            $ref: '#/definitions/error_response'
    post:
      tags: [ organisaties ]
      summary: Voeg een nieuwe organisatie toe
      produces:
        - application/json
      parameters:
      -
        in: body
        name: body
        description: Toevoegen van een nieuw organsatie object
        required: true
        schema:
          $ref: '#/definitions/organisatie-post'
      responses:
        201:
          description: Nieuwe organisatie is toegevoegd
          schema:
            $ref: '#/definitions/organisatie'
        500:
          description: server error
          schema:
            $ref: '#/definitions/error_response'

  /zorg/activiteit/{guid}:
    get:
      tags: [ activiteiten ]
      summary: Toon de activiteit met deze guid
      produces:
        - application/json
      parameters:
      -
        name: guid
        in: path
        description: Paginering, toont de gevraagde pagina
        type: string
        required: true
      responses:
        200:
          description: Retourneert een activeit data record
          schema:
            $ref: '#/definitions/activiteit'
        500:
          description: server error
          schema:
            $ref: '#/definitions/error_response'
    put:
      tags: [ activiteiten ]
      summary: Wijzig de gegevens van activiteit met deze guid
      produces:
        - application/json
      consumes:
        - application/json
      parameters:
      - name: guid
        in: path
        description: Het guid van de activiteit die gewijzigd gaat worden
        type: string
        required: true
      - in: body
        name: body
        description: wijzig activiteit object
        required: false
        schema:
          $ref: "#/definitions/activiteit-post"
      responses:
        "405":
          description: Validation error
        "404":
          description: Activiteit not found
        "400":
          description: Bad request, invalid URL
        "200":
          description: Update successful
    delete:
      tags: [ activiteiten ]
      summary: Verwijder de activiteit met deze guid
      parameters:
      - name: guid
        in: path
        description: Het guid van de activiteit die verwijderd gaat worden
        type: string
        required: true
      responses:
        "200":
          description: Delete successful

  /zorg/activiteit:
    get:
      tags: [ activiteiten  ]
      summary: Toon de lijst met activiteiten
      # operationId: api.datasets.normailzed.views.OrganisatieViewSet
      produces:
        - application/json
      parameters:
      -
        name: page
        in: query
        description: Paginering, toont de gevraagde pagina.
        type: number
        format: int64
        required: false
      responses:
        200:
          description: Retourneert een lijst met activiteiten.
          schema:
            type: object
            properties:
              _links:
                $ref: '#/definitions/_links'
              results:
                type: array
                items:
                  $ref: '#/definitions/results'
        500:
          description: server error
          schema:
            $ref: '#/definitions/error_response'
    post:
      tags: [ activiteiten  ]
      summary: Voeg een nieuwe activiteit toe
      produces:
        - application/json
      parameters:
      -
        in: body
        name: body
        description: Toevoegen van een nieuw activiteit object
        required: true
        schema:
          $ref: '#/definitions/activiteit-post'
      responses:
        201:
          description: Nieuwe activiteit is toegevoegd
          schema:
            type: object
        500:
          description: server error
          schema:
            $ref: '#/definitions/error_response'

  /zorg/locatie/{guid}:
    get:
      tags: [ locaties  ]
      summary: Toon de locatie met deze guid
      produces:
        - application/json
      parameters:
      -
        name: guid
        in: path
        description: Paginering, toont de gevraagde pagina
        type: string
        required: true
      responses:
        200:
          description: retourneert een locatie data record
          schema:
            $ref: '#/definitions/locatie'
        500:
          description: server error
          schema:
            $ref: '#/definitions/error_response'

    put:
      tags: [ locaties ]
      summary: Wijzig de gegevens van de locatie met deze guid
      produces:
        - application/json
      consumes:
        - application/json
      parameters:
      - name: guid
        in: path
        description: Het guid van de locatie die gewijzigd gaat worden
        type: string
        required: true
      - in: body
        name: body
        description: wijzig locatie object
        required: false
        schema:
          $ref: "#/definitions/locatie"
      responses:
        "405":
          description: Validation error
        "404":
          description: Locatie not found
        "400":
          description: Bad request, invalid URL
        "200":
          description: Update successful
    delete:
      tags: [ locaties ]
      summary: Verwijder de locatie met deze guid
      parameters:
      - name: guid
        in: path
        description: Het guid van de locatie die gewijzigd gaat worden
        type: string
        required: true
      responses:
        "200":
          description: Delete successful

  /zorg/locatie:
    get:
      tags: [ locaties ]
      summary: Toon de lijst met locaties
      # operationId: api.datasets.normailzed.views.OrganisatieViewSet
      produces:
        - application/json
      parameters:
      -
        name: page
        in: query
        description: Paginering, toont de gevraagde pagina
        type: number
        format: int64
        required: false
      responses:
        200:
          description: Retourneert een liojst met locatie data
          schema:
            type: object
            properties:
              _links:
                $ref: '#/definitions/_links'
              results:
                type: array
                items:
                  $ref: '#/definitions/results'
        500:
          description: server error
          schema:
            $ref: '#/definitions/error_response'
    post:
      tags: [ locaties ]
      summary: Voeg een nieuwe locatie toe
      produces:
        - application/json
      consumes:
        - application/json
      parameters:
      -
        in: body
        name: body
        description: Toevoegen van een nieuw locatie object
        required: true
        schema:
          $ref: '#/definitions/locatie-post'
      responses:
        201:
          description: Nieuwe activiteit is toegevoegd
          schema:
            type: object
        500:
          description: server error
          schema:
            $ref: '#/definitions/error_response'

#  /zorg/persoon:
#    get:
#      tags: [ persoon  ]
#      summary: data persoon
#      produces:
#        - application/json
#      parameters:
#      -
#        name: page
#        in: query
#        description: Paginering, toont de gevraagde pagina
#        type: number
#        format: int64
#        required: false
#      responses:
#        200:
#          description: Retourneert een lijst met contactpersoon data
#          schema:
#            type: object
#            properties:
#              _links:
#                $ref: '#/definitions/_links'
#              results:
#                type: array
#                items:
#                  $ref: '#/definitions/persoon'
#        500:
#          description: server error
#          schema:
#            $ref: '#/definitions/error_response'
#    post:
#      tags: [ persoon ]
#      summary: Voeg een nieuwe contactpersoon  toe
#      produces:
#        - application/json
#      consumes:
#        - application/json
#      parameters:
#      -
#        in: body
#        name: body
#        description: Toevoegen van een nieuw contactpersoon object
#        required: true
#        schema:
#          $ref: '#/definitions/persoon'
#      responses:
#        201:
#          description: Nieuw contactpersoon is toegevoegd
#          schema:
#            type: object
#        500:
#          description: server error
#          schema:
#            $ref: '#/definitions/error_response'


parameters:
  query:
    name: query
    in: query
    description: de woorden / delen van woorden waarop gezocht wordt
    type: string
    required: false
  tag:
    name: tag
    in: query
    description: zoek naar een tag (bijvoorbeeld `tag=betaald` of `tag=maandag`)
    required: false
    type: string
  latitude:
    name: lat
    in: query
    description: latitude (heeft alleen effect als `lon` ook aanwezig is)
    required: false
    type: number
  longitude:
    name: lon
    in: query
    description: longitude (heeft alleen effect als `lat` ook aanwezig is)
    required: false
    type: number


responses:
  200-zoek:
    description: Retourneert een lijst met zoekresulaten
    schema:
      type: object
      properties:
        took:
          type: number
          format: int64
        timed_out:
          type: boolean
        _shards:
          type: object
        hits:
          type: array
          items:
            type: object
            properties:
              total:
                type: number
                format: int64
              max_score:
                type: number
                format: float
              hits:
                type: array
                items:
                  type: object
  500:
    description: server error
    schema:
      $ref: '#/definitions/error_response'

################################################################################
#                                  Definitions                                 #
################################################################################

definitions:

  organisatie-post:
    type: object
    required:
      - id
      - naam
    properties:
      id:
        type: string
      naam:
        type: string
      beschrijving:
        type: string
      afdeling:
        type: string
      contact:
        description: |
          een lijst met adressen, bijv
          [{"soort":"email", "adres":"voorbeeld@domain.dom"},
           {"soort":"twitter", "adres":"@voorbeeld"}]
        type: array
        items:
            $ref: '#/definitions/comm'
      locatie_id:
        type: string

  organisatie:
    type: object
    required:
      - id
      - guid
      - naam
    properties:
      id:
        type: string
      guid:
        type: string
      naam:
        type: string
      beschrijving:
        type: string
      afdeling:
        type: string
      contact:
        type: array
        items:
            $ref: '#/definitions/comm'
        description: |
          Een lijst met adressen, Voorbeeld:
          [{"soort":"email", "adres":"voorbeeld@domain.dom"},
          {"soort":"twitter", "adres":"@voorbeeld"}]
      locatie_id:
        type: string

  locatie-post:
    type: object
    required:
      - id
      - naam
      - postcode
    properties:
      id:
        type: string
      naam:
        type: string
      openbare_ruimte_naam:
        type: string
      postcode:
        type: string
      huisnummer:
        type: string
      huisletter:
        type: string
      huisnummer_toevoeging:
        type: string

  locatie:
    type: object
    required:
      - id
      - guid
      - naam
    properties:
      id:
        type: string
      guid:
        type: string
      naam:
        type: string
      openbare_ruimte_naam:
        type: string
      postcode:
        type: string
      huisnummer:
        type: string
      huisletter:
        type: string
      huisnummer_toevoeging:
        type: string
      bag_link:
        type: string
      geometrie:
        type: string

  activiteit-post:
    type: object
    required:
      - id
      - naam
    properties:
      id:
        type: string
      naam:
        type: string
      beschrijving:
        type: string
      bron_link:
        type: string
      contactpersoon:
        type: string
      tags:
        type: array
        description: een array van labels / tags passend bij deze activiteit.
        items:
          type: string
      start_time:
        type: string
        format: date-time
        description: Datum / tijd waarop deze activiteit ingaat / aanvangt.
      end_time:
        type: string
        format: date-time
        description: Datum / tijd waarop deze activiteit stopt.
      locatie_id:
        type: string
        description: De `locatie-guid` zoals het bekend is bij het zorg portaal.
      organisatie_id:
        type: string
        description: De `organisatie-id` zoals het bekend is bij het zorg portaal.

  activiteit:
    type: object
    required:
      - id
      - guid
      - naam
    properties:
      id:
        type: string
      guid:
        type: string
      naam:
        type: string
      beschrijving:
        type: string
      bron_link:
        type: string
      contactpersoon:
        type: string
      persoon:
        type: array
      tags:
        type: array
        description: een array van labels / tags passend bij deze activiteit.
        items:
          type: string
      start_time:
        type: string
        format: date-time
        description: Datum / tijd waarop deze activiteit ingaat / aanvangt.
      end_time:
        type: string
        format: date-time
        description: Datum / tijd waarop deze activiteit stopt.
      locatie_id:
        type: string
        description: De `locatie-id` zoals het bekend is bij het zorg portaal.
      organisatie_id:
        type: string
        description: De `organisatie-id` zoals het bekend is bij het zorg portaal.

#  persoon:
#    type: object
#    properties:
#      guid:
#        type: string
#      contact:
#        description: |
#          een lijst met adressen, bijv
#          [{"soort":"email", "adres":"voorbeeld@domain.dom"},
#           {"soort":"twitter", "adres":"@voorbeeld"}]
#        type: array
#        items:
#            $ref: '#/definitions/comm'
#      naam:
#        type: string

  comm:
    type: object
    properties:
      soort:
        type: string
      adres:
        type: string

  href:
    type: object
    properties:
      href:
        type: string

  _links:
    type: object
    properties:
      self:
        $ref: '#/definitions/href'
      next:
        $ref: '#/definitions/href'
      prev:
        $ref: '#/definitions/href'

  results:
    type: object
    allOf:
      - $ref: '#/definitions/activiteit'
      - $ref: '#/definitions/locatie'
      - $ref: '#/definitions/organisatie'

  error_response:
    type: object
    required:
      - message
      - code
    properties:
      message:
        type: string
      code:
        type: string

  batch_record:
    type: object
    properties:
      operatie:
        type: string
        enum:
          - insert
          - update
          - delete
      locatie:
        $ref: '#/definitions/locatie'
      activiteit:
        $ref: '#/definitions/activiteit'

  batch_job:
    type: object
    properties:
      jobid:
        type: number
        format: int64
      guid:
        type: string
      status:
        type: string
        enum:
           - queued
           - running
           - success
           - failed
      result:
        type: object
        properties:
          added:
            type: number
            format: int64
          updated:
            type: number
            format: int64
          deleted:
            type: number
            format: int64
          messages:
            type: string

  tagdefinitie:
    type: object
    properties:
      category:
        type: string
        enum:
          - BETAALD
          - DAG
          - TIJD
      naam:
        type: string
